LDFLAGS += -Wl,-M=$(TARGET).map

OBJS = $(CSRCS:.c=.o) 
OBJS += $(ASMSRCS:.S=.o)

TARGETS = $(TARGET).elf $(TARGET).bin $(TARGET).lst $(TARGET).hex

ifdef STACK_USAGE
.PRECIOUS: %.o
TARGETS += $(TARGET).stack_usage
endif

all:: $(TARGETS)
	echo $(TARGETS)

%.elf: $(OBJS)
	$(CC) $(LDFLAGS) -o $@ $^

%.stack_usage : $(OBJS)
	$(AVSTACK) $^ > $*.stack_usage

%.o: %.c
	$(CC) $(CPPFLAGS) $(CFLAGS) -o $@ -c $<  -D__TLOG_FILE__=\"$(shell basename $< .c)\"

# some object files dont consume stack so no .su file is generated by GCC
# avstack.pl expects however that for each .o there is .su
ifdef STACK_USAGE
%.su: %.o
	touch $<
endif

%.o: %.S
	$(AS) $(ASMFLAGS) $<  -o $@

%.lst: $(TARGET).elf
	$(OBJDUMP) -htS $< > $@

%.hex: $(TARGET).elf
	$(OBJCOPY) --output-target=ihex $(OBJCPFLAGS) $< $*.hex

%.bin: $(TARGET).elf $(TARGET).hex
	$(OBJCOPY) $(OBJCPFLAGS) $< $*.bin
	$(SIZE) -C --mcu=$(MCU) $<
